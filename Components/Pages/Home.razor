
@page "/"
@using EverettEats.Models
@using EverettEats.Services
@implements IDisposable
@inject IRecipeService RecipeService
@inject NavigationManager Navigation

<div class="notebook-page home-page">
    <div class="coffee-ring coffee-ring-hero"></div>
    
    <div class="welcome-section">
        <h1 class="page-title">Welcome to my kitchen! üëã</h1>
        <p class="intro-text">
            This is where I keep all my favorite recipes. Some are family classics, 
            others are happy accidents. Feel free to browse around!
        </p>
    </div>

    <div class="search-section">
        <h2 class="section-title">
            <span class="title-text">Quick Search</span>
            <span class="pencil-underline"></span>
        </h2>
        
        <div class="search-wrapper">
            <input type="text"
                   value="@searchTerm"
                   @oninput="OnSearchInput"
                   placeholder="Try 'chocolate' or 'pasta'..."
                   class="search-input" />
        </div>
    </div>

    <div class="recent-recipes">
        <h2 class="section-title">
            <span class="title-text">@(string.IsNullOrWhiteSpace(searchTerm) ? "Recent Additions" : "Search Results")</span>
            <span class="pencil-underline"></span>
        </h2>
        
        @if (recentRecipes.Any())
        {
            <div class="recipe-cards">
                @foreach (var recipe in recentRecipes)
                {
                    <a href="/recipe/@recipe.Slug" class="recipe-card">
                        <div class="recipe-photo-wrapper">
                            @if (!string.IsNullOrEmpty(recipe.ImageUrl))
                            {
                                <img src="@recipe.ImageUrl" alt="@recipe.Title" class="recipe-photo" />
                            }
                            else
                            {
                                <div class="recipe-sketch">üç≥</div>
                            }
                            <div class="tape-decoration"></div>
                        </div>
                        
                        <div class="recipe-info">
                            <h3 class="recipe-name">@recipe.Title</h3>
                            <div class="recipe-meta">
                                <span class="cook-time">‚è±Ô∏è @recipe.CookTime</span>
                                <span class="difficulty">@GetDifficultyEmoji(recipe.Difficulty)</span>
                            </div>
                            <p class="recipe-note">@recipe.Description</p>
                        </div>
                    </a>
                }
            </div>
            
            <div class="view-all-wrapper">
                <a href="/recipes" class="view-all-link">
                    See all recipes ‚Üí
                </a>
            </div>
        }
        else
        {
            <div class="empty-state">
                <p class="empty-message">No recipes yet! Time to start cooking... ü•ò</p>
            </div>
        }
    </div>
</div>

@code {
    private string searchTerm = "";
    private List<Recipe> recentRecipes = new();
    private List<Recipe> allRecipes = new();
    private System.Timers.Timer? debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        allRecipes = await RecipeService.GetAllRecipesAsync();
        recentRecipes = allRecipes.Take(6).ToList();
    }

    private string GetDifficultyEmoji(DifficultyLevel difficulty) => difficulty switch
    {
        DifficultyLevel.Easy => "üëå Easy",
        DifficultyLevel.Medium => "üëç Medium",
        DifficultyLevel.Hard => "üí™ Challenge",
        _ => "üëå Easy"
    };

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";

        debounceTimer?.Stop();
        debounceTimer?.Dispose();

        debounceTimer = new System.Timers.Timer(300);
        debounceTimer.Elapsed += async (sender, args) =>
        {
            debounceTimer?.Stop();
            await InvokeAsync(() =>
            {
                PerformSearch();
                StateHasChanged();
            });
        };
        debounceTimer.AutoReset = false;
        debounceTimer.Start();
    }

    private void PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            recentRecipes = allRecipes.Take(6).ToList();
        }
        else
        {
            var term = searchTerm.ToLowerInvariant();
            recentRecipes = allRecipes
                .Where(r => r.Title.ToLowerInvariant().Contains(term) ||
                           r.Description.ToLowerInvariant().Contains(term) ||
                           r.Ingredients.Any(i => i.ToLowerInvariant().Contains(term)))
                .ToList();
        }
    }

    public void Dispose()
    {
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
    }
}

@page "/recipe/{Slug}"
@using EverettEats.Models
@using EverettEats.Services
@inject IRecipeService RecipeService
@inject NavigationManager Navigation

@if (recipe != null)
{
    <PageMeta
        Title="@recipe.Title"
        Description="@GetRecipeDescription()"
        ImageUrl="@recipe.ImageUrl"
        Type="article" />

    <div class="recipe-detail-page">
        <button @onclick="GoBack" class="back-button">
            ‚Üê Back to recipes
        </button>

        @if (!string.IsNullOrEmpty(currentHeroImage))
        {
            <div class="recipe-hero">
                <img src="@currentHeroImage" alt="@recipe.Title" class="recipe-hero-image" />
            </div>

            @if (allImages.Count > 1)
            {
                <div class="recipe-gallery">
                    @foreach (var imageUrl in allImages)
                    {
                        <button class="gallery-thumbnail @(imageUrl == currentHeroImage ? "active" : "")"
                                @onclick="() => SelectImage(imageUrl)"
                                type="button"
                                aria-label="View image">
                            <div class="polaroid-frame">
                                <img src="@imageUrl" alt="@recipe.Title" />
                                <div class="tape-corner tape-corner-left"></div>
                                <div class="tape-corner tape-corner-right"></div>
                            </div>
                        </button>
                    }
                </div>
            }
        }

        <div class="recipe-header">
            <h1 class="recipe-title">@recipe.Title</h1>

            @if (!string.IsNullOrEmpty(recipe.Description))
            {
                <p class="recipe-description">@recipe.Description</p>
            }

            <div class="recipe-quick-info">
                <div class="info-card">
                    <span class="info-icon">‚è±Ô∏è</span>
                    <span class="info-label">Prep</span>
                    <span class="info-value">@recipe.PrepTime</span>
                </div>
                <div class="info-card">
                    <span class="info-icon">üî•</span>
                    <span class="info-label">Cook</span>
                    <span class="info-value">@recipe.CookTime</span>
                </div>
                <div class="info-card">
                    <span class="info-icon">üçΩÔ∏è</span>
                    <span class="info-label">Serves</span>
                    <span class="info-value">@recipe.Servings</span>
                </div>
            </div>
        </div>

        <div class="recipe-content">
            <div class="ingredients-section">
                <h2 class="section-header">
                    <span>Shopping List</span>
                    <span class="pencil-mark">‚úì</span>
                </h2>

                <ul class="ingredients-list">
                    @foreach (var ingredient in recipe.Ingredients)
                    {
                        <li class="ingredient-item">
                            <input type="checkbox" id="ing-@ingredient.GetHashCode()" class="ingredient-checkbox" />
                            <label for="ing-@ingredient.GetHashCode()">@ingredient</label>
                        </li>
                    }
                </ul>

                <div class="sticky-note">
                    <p class="note-text">Don't forget to check the pantry first!</p>
                </div>
            </div>

            <div class="instructions-section">
                <h2 class="section-header">
                    <span>Let's Cook!</span>
                    <span class="doodle-arrow">‚Üì</span>
                </h2>

                <ol class="instructions-list">
                    @foreach (var instruction in recipe.Instructions)
                    {
                        <li class="instruction-item">
                            <p>@instruction</p>
                        </li>
                    }
                </ol>

                @if (recipe.Tips.Any())
                {
                    <div class="tips-section">
                        <h3 class="tips-header">Notes to Self:</h3>
                        <ul class="tips-list">
                            @foreach (var tip in recipe.Tips)
                            {
                                <li class="tip-item">@tip</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="loading-state">
        <p>Looking for that recipe... üìñ</p>
    </div>
}

@code {
    [Parameter] public string Slug { get; set; } = "";
    private Recipe? recipe;
    private string currentHeroImage = "";
    private List<string> allImages = [];

    protected override async Task OnInitializedAsync()
    {
        recipe = await RecipeService.GetRecipeBySlugAsync(Slug);
        if (recipe != null)
        {
            allImages = [];
            if (!string.IsNullOrEmpty(recipe.ImageUrl))
            {
                allImages.Add(recipe.ImageUrl);
            }
            if (recipe.GalleryImages?.Count > 0)
            {
                allImages.AddRange(recipe.GalleryImages);
            }
            currentHeroImage = allImages.FirstOrDefault() ?? "";
        }
    }

    private void SelectImage(string imageUrl)
    {
        currentHeroImage = imageUrl;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private string GetRecipeDescription()
    {
        if (recipe == null) return "";

        if (!string.IsNullOrEmpty(recipe.Description))
        {
            return recipe.Description;
        }

        // Fallback description
        return $"Learn how to make {recipe.Title}. Prep time: {recipe.PrepTime}, Cook time: {recipe.CookTime}, Serves: {recipe.Servings}.";
    }
}